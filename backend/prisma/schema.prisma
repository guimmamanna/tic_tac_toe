// Prisma schema for Epic Tic-Tac-Toe

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String
  avatar        String?
  bio           String?
  level         Int      @default(1)
  xp            Int      @default(0)
  eloRating     Int      @default(1000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  gamesAsPlayer1  Game[]        @relation("Player1Games")
  gamesAsPlayer2  Game[]        @relation("Player2Games")
  stats           UserStats?
  achievements    Achievement[]
  friendsFrom     Friend[]      @relation("FriendFrom")
  friendsTo       Friend[]      @relation("FriendTo")
  sentMessages    ChatMessage[]

  @@index([username])
  @@index([eloRating])
}

model Game {
  id           String    @id @default(uuid())
  roomCode     String?   @unique
  mode         GameMode
  status       GameStatus @default(WAITING)
  boardState   Json      // Array of 9 cells
  currentTurn  String?   // User ID or 'ai'
  winner       String?   // User ID, 'ai', or 'draw'
  player1Id    String?
  player2Id    String?
  moves        Json[]    // Array of move objects
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  endedAt      DateTime?

  // Relations
  player1      User?     @relation("Player1Games", fields: [player1Id], references: [id])
  player2      User?     @relation("Player2Games", fields: [player2Id], references: [id])
  chatMessages ChatMessage[]

  @@index([roomCode])
  @@index([status])
  @@index([createdAt])
}

model UserStats {
  id                String   @id @default(uuid())
  userId            String   @unique
  totalGames        Int      @default(0)
  wins              Int      @default(0)
  losses            Int      @default(0)
  draws             Int      @default(0)
  currentStreak     Int      @default(0)
  bestStreak        Int      @default(0)
  totalPlayTime     Int      @default(0) // in seconds
  classicModeWins   Int      @default(0)
  speedModeWins     Int      @default(0)
  ultimateMode      Wins   Int      @default(0)
  powerUpModeWins   Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([wins])
  @@index([totalGames])
}

model Achievement {
  id            String   @id @default(uuid())
  userId        String
  type          AchievementType
  unlockedAt    DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model Friend {
  id            String   @id @default(uuid())
  fromUserId    String
  toUserId      String
  status        FriendStatus @default(PENDING)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  fromUser      User     @relation("FriendFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser        User     @relation("FriendTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
}

model ChatMessage {
  id            String   @id @default(uuid())
  gameId        String
  userId        String
  message       String
  type          MessageType @default(TEXT)
  createdAt     DateTime @default(now())

  // Relations
  game          Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([createdAt])
}

// Enums
enum GameMode {
  CLASSIC
  SPEED
  ULTIMATE
  POWERUP
  AI
}

enum GameStatus {
  WAITING
  ACTIVE
  FINISHED
  ABANDONED
}

enum AchievementType {
  FIRST_WIN
  PERFECT_WEEK
  SPEED_DEMON
  ULTIMATE_MASTER
  SOCIAL_BUTTERFLY
  VETERAN
  CENTURION
  UNSTOPPABLE
  PERFECTIONIST
  COMEBACK_KING
}

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum MessageType {
  TEXT
  EMOJI
  SYSTEM
}
